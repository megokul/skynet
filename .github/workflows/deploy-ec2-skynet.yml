name: Deploy SKYNET on EC2

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: skynet-ec2-deploy
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy on self-hosted runner
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 20
    permissions:
      contents: read
    env:
      OPENCLAW_GATEWAY_URL: ${{ secrets.OPENCLAW_GATEWAY_URL }}
      OPENCLAW_GATEWAY_URLS: ${{ secrets.OPENCLAW_GATEWAY_URLS }}
      SKYNET_API_KEY: ${{ secrets.SKYNET_API_KEY }}
      CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
      SKYNET_AUTH_TOKEN: ${{ secrets.SKYNET_AUTH_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_ALLOWED_USER_ID: ${{ secrets.TELEGRAM_ALLOWED_USER_ID }}
      GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
      GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
      GEMINI_ONLY_MODE: ${{ secrets.GEMINI_ONLY_MODE }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
      OPENROUTER_FALLBACK_MODELS: ${{ secrets.OPENROUTER_FALLBACK_MODELS }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      SKYNET_EXTERNAL_SKILL_URLS: ${{ secrets.SKYNET_EXTERNAL_SKILL_URLS }}
      SKYNET_EXTERNAL_SKILLS_DIR: ${{ secrets.SKYNET_EXTERNAL_SKILLS_DIR }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect gateway changes
        id: changes
        shell: bash
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "gateway_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          CHANGED="$(git diff --name-only "$BEFORE" "$AFTER")"
          echo "Changed files:"
          echo "$CHANGED"
          if echo "$CHANGED" | grep -Eq '^(openclaw-gateway/|docker-compose\.yml|\.github/workflows/deploy-ec2-skynet\.yml$)'; then
            echo "gateway_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "gateway_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate required secrets
        shell: bash
        run: |
          : "${OPENCLAW_GATEWAY_URL:?Missing OPENCLAW_GATEWAY_URL secret}"
          : "${SKYNET_API_KEY:?Missing SKYNET_API_KEY secret}"
          if [ "${{ steps.changes.outputs.gateway_changed }}" = "true" ]; then
            : "${SKYNET_AUTH_TOKEN:?Missing SKYNET_AUTH_TOKEN secret}"
            : "${TELEGRAM_BOT_TOKEN:?Missing TELEGRAM_BOT_TOKEN secret}"
            : "${TELEGRAM_ALLOWED_USER_ID:?Missing TELEGRAM_ALLOWED_USER_ID secret}"
            : "${GOOGLE_AI_API_KEY:?Missing GOOGLE_AI_API_KEY secret}"
          fi

      - name: Build deployment env file
        shell: bash
        run: |
          {
            printf 'OPENCLAW_GATEWAY_URL=%s\n' "${OPENCLAW_GATEWAY_URL}"
            printf 'OPENCLAW_GATEWAY_URLS=%s\n' "${OPENCLAW_GATEWAY_URLS}"
            printf 'SKYNET_API_KEY=%s\n' "${SKYNET_API_KEY}"
            printf 'CORS_ORIGINS=%s\n' "${CORS_ORIGINS:-*}"
            printf 'SKYNET_AUTH_TOKEN=%s\n' "${SKYNET_AUTH_TOKEN}"
            printf 'TELEGRAM_BOT_TOKEN=%s\n' "${TELEGRAM_BOT_TOKEN}"
            printf 'TELEGRAM_ALLOWED_USER_ID=%s\n' "${TELEGRAM_ALLOWED_USER_ID}"
            printf 'GOOGLE_AI_API_KEY=%s\n' "${GOOGLE_AI_API_KEY}"
            printf 'GEMINI_MODEL=%s\n' "${GEMINI_MODEL:-gemini-2.0-flash}"
            printf 'GEMINI_ONLY_MODE=%s\n' "${GEMINI_ONLY_MODE:-1}"
            printf 'GROQ_API_KEY=%s\n' "${GROQ_API_KEY}"
            printf 'OPENROUTER_API_KEY=%s\n' "${OPENROUTER_API_KEY}"
            printf 'OPENROUTER_MODEL=%s\n' "${OPENROUTER_MODEL}"
            printf 'OPENROUTER_FALLBACK_MODELS=%s\n' "${OPENROUTER_FALLBACK_MODELS}"
            printf 'DEEPSEEK_API_KEY=%s\n' "${DEEPSEEK_API_KEY}"
            printf 'OPENAI_API_KEY=%s\n' "${OPENAI_API_KEY}"
            printf 'ANTHROPIC_API_KEY=%s\n' "${ANTHROPIC_API_KEY}"
            printf 'SKYNET_EXTERNAL_SKILL_URLS=%s\n' "${SKYNET_EXTERNAL_SKILL_URLS}"
            printf 'SKYNET_EXTERNAL_SKILLS_DIR=%s\n' "${SKYNET_EXTERNAL_SKILLS_DIR}"
          } > .env.ci
          chmod 600 .env.ci

      - name: Deploy SKYNET API only (leave OpenClaw containers untouched)
        shell: bash
        run: |
          docker compose --env-file .env.ci -f docker-compose.skynet-only.yml \
            up -d --build --no-deps skynet-api

      - name: Deploy OpenClaw gateway when gateway files changed
        if: steps.changes.outputs.gateway_changed == 'true'
        shell: bash
        run: |
          if docker ps -a --format '{{.Names}}' | grep -qx 'openclaw-gateway'; then
            echo "Removing existing openclaw-gateway container to avoid name conflict"
            docker rm -f openclaw-gateway
          fi
          docker compose --env-file .env.ci \
            up -d --build --no-deps openclaw-gateway

      - name: Verify deployment
        shell: bash
        run: |
          docker compose --env-file .env.ci -f docker-compose.skynet-only.yml ps
          for i in {1..20}; do
            if curl -fsS http://127.0.0.1:8000/v1/health > /dev/null; then
              echo "Health check passed"
              exit 0
            fi
            sleep 3
          done
          echo "Health check failed"
          docker compose --env-file .env.ci -f docker-compose.skynet-only.yml \
            logs --tail=100 skynet-api
          exit 1

      - name: Verify OpenClaw gateway deployment
        if: steps.changes.outputs.gateway_changed == 'true'
        shell: bash
        run: |
          docker compose --env-file .env.ci ps openclaw-gateway
          if ! docker compose --env-file .env.ci ps --status running openclaw-gateway | grep -q openclaw-gateway; then
            echo "OpenClaw gateway is not running"
            docker compose --env-file .env.ci logs --tail=120 openclaw-gateway
            exit 1
          fi

      - name: Verify OpenClaw provider wiring
        if: steps.changes.outputs.gateway_changed == 'true'
        shell: bash
        run: |
          GEMINI_ONLY_MODE_NORMALIZED="$(printf '%s' "${GEMINI_ONLY_MODE:-1}" | tr '[:upper:]' '[:lower:]')"
          if [ "$GEMINI_ONLY_MODE_NORMALIZED" = "true" ] || [ "$GEMINI_ONLY_MODE_NORMALIZED" = "yes" ] || [ "$GEMINI_ONLY_MODE_NORMALIZED" = "on" ]; then
            GEMINI_ONLY_MODE_NORMALIZED="1"
          fi

          # Ensure env vars were injected into the running container.
          if ! docker inspect openclaw-gateway --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -q '^GOOGLE_AI_API_KEY=.'; then
            echo "GOOGLE_AI_API_KEY is not present in openclaw-gateway container env."
            exit 1
          fi
          if ! docker inspect openclaw-gateway --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -q '^GEMINI_ONLY_MODE=.'; then
            echo "GEMINI_ONLY_MODE is not present in openclaw-gateway container env."
            exit 1
          fi

          # Give gateway a moment to log provider registration.
          sleep 5
          LOGS="$(docker logs --tail=200 openclaw-gateway 2>&1 || true)"
          if ! echo "$LOGS" | grep -q 'Registered provider: Gemini Flash'; then
            echo "Gemini provider was not registered at startup."
            echo "$LOGS"
            exit 1
          fi

          if [ "$GEMINI_ONLY_MODE_NORMALIZED" = "1" ]; then
            if echo "$LOGS" | grep -Eq 'Registered provider: (Ollama|Groq|OpenRouter|DeepSeek|OpenAI|Claude)'; then
              echo "Gemini-only mode is enabled, but non-Gemini providers were registered."
              echo "$LOGS"
              exit 1
            fi
          else
            if ! echo "$LOGS" | grep -Eq 'Registered provider: (Groq|OpenRouter|DeepSeek|OpenAI|Claude)'; then
              echo "No fallback cloud provider was registered at startup."
              echo "$LOGS"
              exit 1
            fi
          fi

      - name: Cleanup env file
        if: always()
        shell: bash
        run: rm -f .env.ci
