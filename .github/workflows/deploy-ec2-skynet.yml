name: SKYNET CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: skynet-ci-cd
  cancel-in-progress: true

jobs:
  guard:
    name: Path Guard
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Check stale paths
        run: python scripts/ci/check_stale_paths.py

      - name: Check control-plane boundary
        run: python scripts/ci/check_control_plane_boundary.py

  deploy:
    name: Deploy on self-hosted runner
    needs: guard
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 20
    permissions:
      contents: read
    env:
      OPENCLAW_GATEWAY_URL: ${{ secrets.OPENCLAW_GATEWAY_URL }}
      OPENCLAW_GATEWAY_URLS: ${{ secrets.OPENCLAW_GATEWAY_URLS }}
      SKYNET_API_KEY: ${{ secrets.SKYNET_API_KEY }}
      CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
      SKYNET_AUTH_TOKEN: ${{ secrets.SKYNET_AUTH_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_ALLOWED_USER_ID: ${{ secrets.TELEGRAM_ALLOWED_USER_ID }}
      GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
      GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}
      GEMINI_ONLY_MODE: ${{ secrets.GEMINI_ONLY_MODE }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
      OPENROUTER_FALLBACK_MODELS: ${{ secrets.OPENROUTER_FALLBACK_MODELS }}
      DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      AI_PROVIDER_PRIORITY: ${{ secrets.AI_PROVIDER_PRIORITY }}
      AUTO_APPROVE_GIT_ACTIONS: ${{ secrets.AUTO_APPROVE_GIT_ACTIONS }}
      AUTO_APPROVE_AND_START: ${{ secrets.AUTO_APPROVE_AND_START }}
      AUTO_PLAN_MIN_IDEAS: ${{ secrets.AUTO_PLAN_MIN_IDEAS }}
      AUTO_BOOTSTRAP_PROJECT: ${{ secrets.AUTO_BOOTSTRAP_PROJECT }}
      AUTO_CREATE_GITHUB_REPO: ${{ secrets.AUTO_CREATE_GITHUB_REPO }}
      AUTO_CREATE_GITHUB_PRIVATE: ${{ secrets.AUTO_CREATE_GITHUB_PRIVATE }}
      SKYNET_PROJECT_BASE_DIR: ${{ secrets.SKYNET_PROJECT_BASE_DIR }}
      SKYNET_EXTERNAL_SKILL_URLS: ${{ secrets.SKYNET_EXTERNAL_SKILL_URLS }}
      SKYNET_EXTERNAL_SKILLS_DIR: ${{ secrets.SKYNET_EXTERNAL_SKILLS_DIR }}
      OPENCLAW_EXECUTION_MODE: ${{ secrets.OPENCLAW_EXECUTION_MODE }}
      OPENCLAW_SSH_FALLBACK_ENABLED: ${{ secrets.OPENCLAW_SSH_FALLBACK_ENABLED }}
      OPENCLAW_SSH_HOST: ${{ secrets.OPENCLAW_SSH_HOST }}
      OPENCLAW_SSH_PORT: ${{ secrets.OPENCLAW_SSH_PORT }}
      OPENCLAW_SSH_USER: ${{ secrets.OPENCLAW_SSH_USER }}
      OPENCLAW_SSH_PASSWORD: ${{ secrets.OPENCLAW_SSH_PASSWORD }}
      OPENCLAW_SSH_KEY_PATH: ${{ secrets.OPENCLAW_SSH_KEY_PATH }}
      OPENCLAW_SSH_KEY_FILE: ${{ secrets.OPENCLAW_SSH_KEY_FILE }}
      OPENCLAW_SSH_PRIVATE_KEY_B64: ${{ secrets.OPENCLAW_SSH_PRIVATE_KEY_B64 }}
      OPENCLAW_SSH_CONNECT_TIMEOUT: ${{ secrets.OPENCLAW_SSH_CONNECT_TIMEOUT }}
      OPENCLAW_SSH_COMMAND_TIMEOUT: ${{ secrets.OPENCLAW_SSH_COMMAND_TIMEOUT }}
      OPENCLAW_SSH_HEALTH_CACHE_SECONDS: ${{ secrets.OPENCLAW_SSH_HEALTH_CACHE_SECONDS }}
      OPENCLAW_SSH_REMOTE_OS: ${{ secrets.OPENCLAW_SSH_REMOTE_OS }}
      OPENCLAW_SSH_ALLOWED_ROOTS: ${{ secrets.OPENCLAW_SSH_ALLOWED_ROOTS }}
      OPENCLAW_SSH_STRICT_HOST_KEY: ${{ secrets.OPENCLAW_SSH_STRICT_HOST_KEY }}
      OPENCLAW_SSH_CODEX_BIN: ${{ secrets.OPENCLAW_SSH_CODEX_BIN }}
      OPENCLAW_SSH_CLAUDE_BIN: ${{ secrets.OPENCLAW_SSH_CLAUDE_BIN }}
      OPENCLAW_SSH_CLINE_BIN: ${{ secrets.OPENCLAW_SSH_CLINE_BIN }}
      OPENCLAW_LAPTOP_SSH_PUBLIC_KEY: ${{ secrets.OPENCLAW_LAPTOP_SSH_PUBLIC_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          : "${OPENCLAW_GATEWAY_URL:?Missing OPENCLAW_GATEWAY_URL secret}"
          : "${SKYNET_API_KEY:?Missing SKYNET_API_KEY secret}"
          : "${SKYNET_AUTH_TOKEN:?Missing SKYNET_AUTH_TOKEN secret}"
          : "${TELEGRAM_BOT_TOKEN:?Missing TELEGRAM_BOT_TOKEN secret}"
          : "${TELEGRAM_ALLOWED_USER_ID:?Missing TELEGRAM_ALLOWED_USER_ID secret}"
          : "${GOOGLE_AI_API_KEY:?Missing GOOGLE_AI_API_KEY secret}"

      - name: Authorize laptop SSH key for reverse tunnel
        shell: bash
        run: |
          if [ -n "${OPENCLAW_LAPTOP_SSH_PUBLIC_KEY:-}" ]; then
            mkdir -p "$HOME/.ssh"
            touch "$HOME/.ssh/authorized_keys"
            chmod 700 "$HOME/.ssh"
            chmod 600 "$HOME/.ssh/authorized_keys"
            if grep -Fqx "${OPENCLAW_LAPTOP_SSH_PUBLIC_KEY}" "$HOME/.ssh/authorized_keys"; then
              echo "Laptop SSH key already authorized on runner host."
            else
              printf '%s\n' "${OPENCLAW_LAPTOP_SSH_PUBLIC_KEY}" >> "$HOME/.ssh/authorized_keys"
              echo "Authorized laptop SSH key on runner host."
            fi
          else
            echo "OPENCLAW_LAPTOP_SSH_PUBLIC_KEY not set; skipping authorized_keys update."
          fi

      - name: Prepare SSH key material
        shell: bash
        run: |
          if [ -n "${OPENCLAW_SSH_PRIVATE_KEY_B64:-}" ]; then
            mkdir -p .secrets
            printf '%s' "${OPENCLAW_SSH_PRIVATE_KEY_B64}" | base64 -d > .secrets/laptop_ed25519
            chmod 600 .secrets/laptop_ed25519
            echo "OPENCLAW_SSH_KEY_FILE=.secrets/laptop_ed25519" >> "$GITHUB_ENV"
            if [ -z "${OPENCLAW_SSH_KEY_PATH:-}" ]; then
              echo "OPENCLAW_SSH_KEY_PATH=/app/keys/laptop_ed25519" >> "$GITHUB_ENV"
            fi
          fi

      - name: Build deployment env file
        shell: bash
        run: |
          {
            printf 'OPENCLAW_GATEWAY_URL=%s\n' "${OPENCLAW_GATEWAY_URL}"
            printf 'OPENCLAW_GATEWAY_URLS=%s\n' "${OPENCLAW_GATEWAY_URLS}"
            printf 'SKYNET_API_KEY=%s\n' "${SKYNET_API_KEY}"
            printf 'CORS_ORIGINS=%s\n' "${CORS_ORIGINS:-*}"
            printf 'SKYNET_AUTH_TOKEN=%s\n' "${SKYNET_AUTH_TOKEN}"
            printf 'TELEGRAM_BOT_TOKEN=%s\n' "${TELEGRAM_BOT_TOKEN}"
            printf 'TELEGRAM_ALLOWED_USER_ID=%s\n' "${TELEGRAM_ALLOWED_USER_ID}"
            printf 'GOOGLE_AI_API_KEY=%s\n' "${GOOGLE_AI_API_KEY}"
            printf 'GEMINI_MODEL=%s\n' "${GEMINI_MODEL:-gemini-2.0-flash}"
            printf 'GEMINI_ONLY_MODE=%s\n' "${GEMINI_ONLY_MODE:-0}"
            printf 'GROQ_API_KEY=%s\n' "${GROQ_API_KEY}"
            printf 'OPENROUTER_API_KEY=%s\n' "${OPENROUTER_API_KEY}"
            printf 'OPENROUTER_MODEL=%s\n' "${OPENROUTER_MODEL:-qwen/qwen3-next-80b-a3b-instruct:free}"
            printf 'OPENROUTER_FALLBACK_MODELS=%s\n' "${OPENROUTER_FALLBACK_MODELS:-qwen/qwen3-vl-235b-a22b-thinking,openai/gpt-oss-120b:free,qwen/qwen3-coder:free,google/gemma-3n-e2b-it:free,deepseek/deepseek-r1-0528:free,meta-llama/llama-3.3-70b-instruct:free}"
            printf 'DEEPSEEK_API_KEY=%s\n' "${DEEPSEEK_API_KEY}"
            printf 'OPENAI_API_KEY=%s\n' "${OPENAI_API_KEY}"
            printf 'ANTHROPIC_API_KEY=%s\n' "${ANTHROPIC_API_KEY}"
            printf 'AI_PROVIDER_PRIORITY=%s\n' "${AI_PROVIDER_PRIORITY:-gemini,groq,openrouter,deepseek,openai,claude,ollama}"
            printf 'AUTO_APPROVE_GIT_ACTIONS=%s\n' "${AUTO_APPROVE_GIT_ACTIONS:-1}"
            printf 'AUTO_APPROVE_AND_START=%s\n' "${AUTO_APPROVE_AND_START:-1}"
            printf 'AUTO_PLAN_MIN_IDEAS=%s\n' "${AUTO_PLAN_MIN_IDEAS:-3}"
            printf 'AUTO_BOOTSTRAP_PROJECT=%s\n' "${AUTO_BOOTSTRAP_PROJECT:-1}"
            printf 'AUTO_CREATE_GITHUB_REPO=%s\n' "${AUTO_CREATE_GITHUB_REPO:-1}"
            printf 'AUTO_CREATE_GITHUB_PRIVATE=%s\n' "${AUTO_CREATE_GITHUB_PRIVATE:-0}"
            printf 'SKYNET_PROJECT_BASE_DIR=%s\n' "${SKYNET_PROJECT_BASE_DIR:-E:\\MyProjects}"
            printf 'SKYNET_EXTERNAL_SKILL_URLS=%s\n' "${SKYNET_EXTERNAL_SKILL_URLS}"
            printf 'SKYNET_EXTERNAL_SKILLS_DIR=%s\n' "${SKYNET_EXTERNAL_SKILLS_DIR}"
            printf 'OPENCLAW_EXECUTION_MODE=%s\n' "${OPENCLAW_EXECUTION_MODE}"
            printf 'OPENCLAW_SSH_FALLBACK_ENABLED=%s\n' "${OPENCLAW_SSH_FALLBACK_ENABLED:-0}"
            printf 'OPENCLAW_SSH_HOST=%s\n' "${OPENCLAW_SSH_HOST}"
            printf 'OPENCLAW_SSH_PORT=%s\n' "${OPENCLAW_SSH_PORT:-2222}"
            printf 'OPENCLAW_SSH_USER=%s\n' "${OPENCLAW_SSH_USER}"
            printf 'OPENCLAW_SSH_PASSWORD=%s\n' "${OPENCLAW_SSH_PASSWORD}"
            printf 'OPENCLAW_SSH_KEY_PATH=%s\n' "${OPENCLAW_SSH_KEY_PATH}"
            printf 'OPENCLAW_SSH_KEY_FILE=%s\n' "${OPENCLAW_SSH_KEY_FILE:-/dev/null}"
            printf 'OPENCLAW_SSH_CONNECT_TIMEOUT=%s\n' "${OPENCLAW_SSH_CONNECT_TIMEOUT:-4}"
            printf 'OPENCLAW_SSH_COMMAND_TIMEOUT=%s\n' "${OPENCLAW_SSH_COMMAND_TIMEOUT:-180}"
            printf 'OPENCLAW_SSH_HEALTH_CACHE_SECONDS=%s\n' "${OPENCLAW_SSH_HEALTH_CACHE_SECONDS:-15}"
            printf 'OPENCLAW_SSH_REMOTE_OS=%s\n' "${OPENCLAW_SSH_REMOTE_OS:-windows}"
            printf 'OPENCLAW_SSH_ALLOWED_ROOTS=%s\n' "${OPENCLAW_SSH_ALLOWED_ROOTS:-E:\\MyProjects}"
            printf 'OPENCLAW_SSH_STRICT_HOST_KEY=%s\n' "${OPENCLAW_SSH_STRICT_HOST_KEY:-0}"
            printf 'OPENCLAW_SSH_CODEX_BIN=%s\n' "${OPENCLAW_SSH_CODEX_BIN:-codex}"
            printf 'OPENCLAW_SSH_CLAUDE_BIN=%s\n' "${OPENCLAW_SSH_CLAUDE_BIN:-claude}"
            printf 'OPENCLAW_SSH_CLINE_BIN=%s\n' "${OPENCLAW_SSH_CLINE_BIN:-cline}"
          } > .env.ci
          chmod 600 .env.ci

      - name: Remove stale OpenClaw gateway container if present
        shell: bash
        run: |
          if docker ps -a --format '{{.Names}}' | grep -qx 'openclaw-gateway'; then
            echo "Removing existing openclaw-gateway container to avoid name conflict"
            docker rm -f openclaw-gateway
          fi

      - name: Deploy full stack
        shell: bash
        run: |
          docker compose --env-file .env.ci up -d --build skynet-api openclaw-gateway

      - name: Verify deployment
        shell: bash
        run: |
          docker compose --env-file .env.ci ps
          for i in {1..20}; do
            if curl -fsS http://127.0.0.1:8000/v1/health > /dev/null; then
              echo "Health check passed"
              break
            fi
            sleep 3
          done
          if ! curl -fsS http://127.0.0.1:8000/v1/health > /dev/null; then
            echo "Health check failed"
            docker compose --env-file .env.ci logs --tail=120 skynet-api
            exit 1
          fi
          docker compose --env-file .env.ci ps openclaw-gateway
          if ! docker compose --env-file .env.ci ps --status running openclaw-gateway | grep -q openclaw-gateway; then
            echo "OpenClaw gateway is not running"
            docker compose --env-file .env.ci logs --tail=120 openclaw-gateway
            exit 1
          fi

      - name: Verify OpenClaw provider wiring
        shell: bash
        run: |
          GEMINI_ONLY_MODE_NORMALIZED="$(printf '%s' "${GEMINI_ONLY_MODE:-0}" | tr '[:upper:]' '[:lower:]')"
          if [ "$GEMINI_ONLY_MODE_NORMALIZED" = "true" ] || [ "$GEMINI_ONLY_MODE_NORMALIZED" = "yes" ] || [ "$GEMINI_ONLY_MODE_NORMALIZED" = "on" ]; then
            GEMINI_ONLY_MODE_NORMALIZED="1"
          fi

          # Ensure env vars were injected into the running container.
          if ! docker inspect openclaw-gateway --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -q '^GOOGLE_AI_API_KEY=.'; then
            echo "GOOGLE_AI_API_KEY is not present in openclaw-gateway container env."
            exit 1
          fi
          if ! docker inspect openclaw-gateway --format '{{range .Config.Env}}{{println .}}{{end}}' | grep -q '^GEMINI_ONLY_MODE=.'; then
            echo "GEMINI_ONLY_MODE is not present in openclaw-gateway container env."
            exit 1
          fi

          # Give gateway a moment to log provider registration.
          sleep 5
          LOGS="$(docker logs --tail=200 openclaw-gateway 2>&1 || true)"
          if ! echo "$LOGS" | grep -q 'Registered provider: Gemini Flash'; then
            echo "Gemini provider was not registered at startup."
            echo "$LOGS"
            exit 1
          fi

          if [ "$GEMINI_ONLY_MODE_NORMALIZED" = "1" ]; then
            if echo "$LOGS" | grep -Eq 'Registered provider: (Ollama|Groq|OpenRouter|DeepSeek|OpenAI|Claude)'; then
              echo "Gemini-only mode is enabled, but non-Gemini providers were registered."
              echo "$LOGS"
              exit 1
            fi
          else
            if ! echo "$LOGS" | grep -Eq 'Registered provider: (Groq|OpenRouter|DeepSeek|OpenAI|Claude)'; then
              echo "No fallback cloud provider was registered at startup."
              echo "$LOGS"
              exit 1
            fi
          fi

      - name: Cleanup env file
        if: always()
        shell: bash
        run: rm -f .env.ci .secrets/laptop_ed25519
